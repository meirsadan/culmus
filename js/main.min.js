var Calligrapher={Pen:function(e){void 0===e&&(e={}),this.position=new paper.Point(e.x||0,e.y||0),this.size=new paper.Size(e.width||100,e.height||5),this.angle=e.angle||-60,this.color=e.color||"black",this._penLayer=new paper.Layer,this._pen=new paper.Shape.Rectangle({position:this.position,size:this.size,rotation:this.angle,fillColor:this.color}),this._pen.addTo(this._penLayer),this.penPoint=new paper.Point({length:this.size.width/2,angle:this.angle})}};Object.assign(Calligrapher.Pen.prototype,{refresh(){this._pen.remove(),this._pen=new paper.Shape.Rectangle({position:this.position,size:this.size,rotation:this.angle,fillColor:this.color})},place(e){this.position.set(e)},resize(e,t){this.size.width=e,this.size.height=t,this.penPoint.length=e/2},rotate(e){this.angle=e,this._pen.rotation=e,this.penPoint.angle=e},createOutgoingSegment(e){return new paper.Segment({point:e.point.add(this.penPoint),handleIn:e.handleIn,handleOut:e.handleOut})},createIncomingSegment(e){return new paper.Segment({point:e.point.subtract(this.penPoint),handleIn:e.handleOut,handleOut:e.handleIn})},createStroke(e,t,n){var i=e.clone({insert:!1});i.removeSegments(e.segments.length/2);var s,o=e.clone({insert:!1});for(o.removeSegments(0,e.segments.length/2),console.log(i.length,o.length),t.removeSegments(),s=0;s<e.segments.length;s++)n[s]&&this.rotate(n[s]),t.add(this.createOutgoingSegment(e.segments[s]));for(t.lastSegment.handleOut=void 0,s=e.segments.length-1;s>=0;s--)n[s]&&this.rotate(n[s]),t.add(this.createIncomingSegment(e.segments[s])),s==e.segments.length-1&&(t.lastSegment.handleIn=void 0);return this.rotate(n[e.segments.length-1]),t},hide(){this._pen.opacity=0},show(){this._pen.opacity=100}}),Calligrapher.Stroke=function(e,t){this.offset=0,this.path=e,this.path.closed=!1,this.angles=[],e.segments.forEach(e=>{this.angles.push(-30-Math.floor(30*Math.random()))}),this.layer=t,t.activate(),this.shape=new paper.Path({strokeWidth:5,strokeColor:"#888",fillColor:"#888",closed:!0,segments:[e.segments.firstSegment]}),this.shape.blendMode="multiply",this.shape.addTo(this.layer),this.length=e.length},Object.assign(Calligrapher.Stroke.prototype,{showSkeleton(){var e=this.path.copyTo(this.layer);e.strokeColor="black",e.fillColor=void 0,e.fullySelected=!0},placePenAt(e,t){void 0===t&&(t=this.offset),e.place(this.path.getPointAt(this.length*t))},drawPhase(e,t){void 0===t&&(t=this.offset);var n=this.path.clone({insert:!1});n.splitAt(Math.floor(n.length*t)),e.createStroke(n,this.shape,this.angles)},drawWithPen(e,t){void 0===t&&(t={});var n="offset"in t?t.offset:1,i="duration"in t?t.duration:this.length,s={offset:this.offset};new TWEEN.Tween(s).to({offset:n},i).easing(TWEEN.Easing.Quadratic.Out).onUpdate(()=>{this.drawPhase(e,s.offset),this.placePenAt(e,s.offset)}).onComplete("oncomplete"in t?t.oncomplete:function(){}).start()},render(e){e.createStroke(this.path,this.shape,this.angles)}}),Calligrapher.Letter=function(){this._letterLayer=new paper.Layer,this._letterLayer.addTo(paper.project),this._letterLayer.sendToBack(),this._pen=new Calligrapher.Pen,this.width=window.innerWidth,this.height=window.innerHeight,this.strokes=[]},Object.assign(Calligrapher.Letter.prototype,{reset(){this._letterLayer.removeChildren()},load(e){this.reset();var t=(new paper.Item).importSVG(e);console.log(t.exportJSON()),t=t.firstChild,t.position=new paper.Point(window.innerWidth/2,window.innerHeight/2),this.paths=t.children,this.paths.forEach(e=>this.strokes.push(new Calligrapher.Stroke(e,this._letterLayer))),this.width=t.bounds.x+t.bounds.width+250,this.height=t.bounds.y+t.bounds.height+250},renderSkeleton(){this.strokes.forEach(e=>e.showSkeleton())},render(){this.strokes.forEach(e=>e.render(this._pen))},draw(){this._letterLayer.activate();var e=0,t=()=>{this._pen.show();var n=this.strokes[e];n.drawWithPen(this._pen,{duration:10*n.length,oncomplete:()=>{e+=1,e<this.strokes.length?t():this._pen.hide()}})};t()}});var animate=function(e){requestAnimationFrame(animate),TWEEN.update(e)},init=function(){var e=document.getElementById("calligrapherCanvas");paper.setup(e),paper.settings.insertItems=!1;var t=new Calligrapher.Letter;opentype.load("fonts/CalligrapherFont-Regular.otf",function(e,n){if(e)console.error("Font could not be loaded: "+e);else{var i=n.getPath("×",0,400,600);console.log(i),window.svgEl=document.createElement("SVG"),svgEl.innerHTML=i.toSVG(),t.load(svgEl),t.renderSkeleton(),t.render()}}),requestAnimationFrame(animate)};window.onload=function(){init()};